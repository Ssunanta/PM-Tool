<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Notes Board</title>
  <style>
 * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f3f3f3;
      color: #333;
    }
    .container { max-width: 1200px; margin: 20px auto; padding: 25px; background: #fff; border-radius: 10px; }
    .title { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #333; display: flex; align-items: center; }
    .notes-board-wrapper { margin-bottom: 20px; }
    .notes-section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; padding: 8px 16px; background: #e8e8e8; border-radius: 8px; display: inline-block; color: #555; }
    .notes-boards { display: flex; gap: 20px; overflow-x: auto; padding: 10px 0; }
    .notes-column { min-width: 320px; width: 320px; border-radius: 16px; padding: 18px; color: white; }
    .notes-col-red { background: linear-gradient(135deg, #8B4A52 0%, #6B3842 100%); }
    .notes-col-blue { background: linear-gradient(135deg, #2C3E6F 0%, #1E2A4A 100%); }
    .notes-col-green { background: linear-gradient(135deg, #3E5132 0%, #2E3C27 100%); }
    .notes-column-header { display: flex; align-items: center; justify-content: space-between; font-size: 15px; font-weight: 500; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
    .notes-header-left { display: flex; align-items: center; gap: 10px; }
    .notes-status-dot { width: 12px; height: 12px; border-radius: 50%; }
    .notes-dot-red { background: #FF6B6B; }
    .notes-dot-blue { background: #80B7FF; }
    .notes-dot-green { background: #85E889; }
    .notes-count { background: rgba(255, 255, 255, 0.2); padding: 3px 10px; border-radius: 12px; font-size: 13px; }
    .notes-card { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); padding: 16px; border-radius: 12px; margin-bottom: 12px; transition: all 0.3s ease; cursor: pointer; }
    .notes-card:hover { transform: translateY(-2px); background: rgba(255, 255, 255, 0.25); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    .notes-card-title { font-size: 15px; margin-bottom: 12px; line-height: 1.5; display: flex; justify-content: space-between; align-items: flex-start; }
    .notes-card-actions { display: flex; gap: 8px; opacity: 0.7; }
    .notes-card-actions i { cursor: pointer; transition: opacity 0.2s; font-size: 14px; font-style: normal; }
    .notes-card-actions i:hover { opacity: 1; }
    .notes-date-range { font-size: 12px; opacity: 0.85; margin-bottom: 10px; }
    .notes-tag { padding: 5px 12px; border-radius: 6px; font-size: 12px; display: inline-block; font-weight: 500; }
    .notes-new-page { margin-top: 8px; padding: 14px; border: 1px dashed rgba(255, 255, 255, 0.4); border-radius: 10px; display: flex; gap: 8px; align-items: center; justify-content: center; font-size: 14px; opacity: 0.8; cursor: pointer; transition: all 0.3s ease; }
    .notes-new-page:hover { opacity: 1; background: rgba(255, 255, 255, 0.15); border-color: rgba(255, 255, 255, 0.7); transform: translateY(-2px); }

    .notes-calendar-section { margin-top: 20px; }
    .notes-calendar-title { font-size: 18px; font-weight: 600; padding: 8px 16px; background: #e8e8e8; border-radius: 8px; display: inline-block; margin-bottom: 16px; color: #555; }
    .calendar-container { background: #fafafa; border: 1px solid #eee; border-radius: 12px; padding: 20px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .calendar-month { font-size: 18px; font-weight: 600; color: #333; }
    .calendar-nav { display: flex; gap: 10px; }
    .calendar-nav button { padding: 8px 16px; border: 1px solid #ddd; background: #fff; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 14px; color: #555; }
    .calendar-nav button:hover { background: #f5f5f5; border-color: #bbb; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    .calendar-day-header { text-align: center; font-weight: 600; font-size: 14px; color: #666; padding: 12px 0; background: #f9f9f9; border-radius: 6px; }
    .calendar-day { min-height: 90px; border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px; cursor: pointer; transition: all 0.2s; position: relative; background: #fff; }
    .calendar-day:hover { background: #f9f9f9; border-color: #ccc; transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
    .calendar-day.other-month { opacity: 0.3; background: #fafafa; }
    .calendar-day.today { border: 2px solid #4A90E2; background: #F0F7FF; }
    .calendar-day-number { font-size: 14px; font-weight: 600; margin-bottom: 6px; color: #333; }
    .calendar-note-item { font-size: 11px; padding: 4px 8px; border-radius: 4px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; transition: all 0.2s ease; }
    .calendar-note-item:hover { transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); }
    .calendar-note-red { background: #FFE0E0; color: #8B4A52; }
    .calendar-note-blue { background: #E0EEFF; color: #2C3E6F; }
    .calendar-note-green { background: #E0FFE0; color: #3E5132; }
    .calendar-tooltip { position: fixed; background: rgba(0, 0, 0, 0.9); color: white; padding: 12px 16px; border-radius: 8px; font-size: 13px; z-index: 9999; pointer-events: none; opacity: 0; visibility: hidden; transition: opacity 0.2s ease; max-width: 250px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
    .calendar-tooltip.show { opacity: 1; visibility: visible; }

    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
    .modal-content { background-color: #8B4A52; margin: 5% auto; padding: 30px; border-radius: 16px; width: 90%; max-width: 450px; color: white; }
    .modal-header { font-size: 20px; font-weight: 600; margin-bottom: 25px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: flex; align-items: center; gap: 10px; font-size: 14px; margin-bottom: 8px; opacity: 0.9; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px dashed rgba(255, 255, 255, 0.4); border-radius: 10px; background: rgba(255, 255, 255, 0.15); color: white; font-size: 14px; }
    .form-group input::placeholder { color: rgba(255, 255, 255, 0.6); }
    .modal-buttons { display: flex; gap: 10px; margin-top: 25px; }
    .btn { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s; }
    .btn-primary { background: white; color: #8B4A52; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
    .btn-secondary { background: rgba(255, 255, 255, 0.2); color: white; }
    .btn-secondary:hover { background: rgba(255, 255, 255, 0.3); }

    .add-note-form { margin-top: 12px; padding: 18px; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.3); animation: slideDown 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .form-input-wrapper { position: relative; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: rgba(139, 74, 82, 0.3); border: 2px dashed rgba(255, 255, 255, 0.4); border-radius: 10px; transition: all 0.2s ease; }
    .form-input-wrapper:focus-within { border-color: rgba(255, 255, 255, 0.7); background: rgba(139, 74, 82, 0.4); transform: translateY(-1px); }
    .form-input { flex: 1; padding: 0; margin: 0; border: none; font-size: 14px; outline: none; background: transparent; color: white; }
    .form-input::placeholder { color: rgba(255, 255, 255, 0.7); }
    .form-input option { background: #2C3E6F; color: white; padding: 8px; }
    .form-title-wrapper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 12px 14px; background: rgba(139, 74, 82, 0.3); border: 2px dashed rgba(255, 255, 255, 0.4); border-radius: 10px; }
    .form-title-left { display: flex; align-items: center; gap: 12px; flex: 1; }
    .form-actions { display: flex; gap: 10px; margin-top: 14px; }
    .form-btn { flex: 1; padding: 11px 16px; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease; }
    .form-btn-save { background: white; color: #8B4A52; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); }
    .form-btn-save:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
    .form-btn-cancel { background: rgba(255, 255, 255, 0.25); color: white; border: 1px solid rgba(255, 255, 255, 0.3); }
    .form-btn-cancel:hover { background: rgba(255, 255, 255, 0.35); border-color: rgba(255, 255, 255, 0.5); }

/* ===== CALENDAR MOBILE RESPONSIVE FIX ===== */

/* Base Calendar Styles (Desktop) */
.calendar-container { 
  padding: 20px; 
}

.calendar-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 20px; 
  gap: 10px;
}

.calendar-month { 
  font-size: 18px; 
  font-weight: 600; 
  color: #333; 
}

.calendar-nav button { 
  padding: 8px 16px; 
  font-size: 14px; 
}

.calendar-grid { 
  display: grid; 
  grid-template-columns: repeat(7, 1fr); 
  gap: 10px; 
}

.calendar-day-header { 
  font-size: 14px; 
  padding: 12px 0; 
}

.calendar-day { 
  min-height: 90px; 
  padding: 10px; 
}

.calendar-day-number { 
  font-size: 14px; 
  margin-bottom: 6px; 
}

.calendar-note-item { 
  font-size: 11px; 
  padding: 4px 8px; 
  margin-bottom: 4px; 
}

/* ===== TABLET (768px and below) ===== */
@media screen and (max-width: 768px) {
  .calendar-container { 
    padding: 12px !important; 
  }
  
  .calendar-header { 
    flex-wrap: wrap; 
    margin-bottom: 12px !important; 
    gap: 8px; 
  }
  
  .calendar-month { 
    font-size: 16px !important; 
    flex-basis: 100%;
  }
  
  .calendar-nav { 
    gap: 6px !important; 
    flex-basis: 100%;
    display: flex;
    justify-content: center;
  }
  
  .calendar-nav button { 
    padding: 6px 12px !important; 
    font-size: 12px !important; 
    flex: 1;
    max-width: 120px;
  }
  
  .calendar-grid { 
    gap: 4px !important; 
  }
  
  .calendar-day-header { 
    font-size: 11px !important; 
    padding: 6px 0 !important; 
    font-weight: 600;
  }
  
  .calendar-day { 
    min-height: 65px !important; 
    padding: 5px !important; 
    overflow: hidden;
  }
  
  .calendar-day-number { 
    font-size: 13px !important; 
    margin-bottom: 3px !important;
    font-weight: 600;
  }
  
  .calendar-note-item { 
    font-size: 10px !important; 
    padding: 3px 6px !important; 
    margin-bottom: 2px !important;
    line-height: 1.2;
  }
}

/* ===== MOBILE LANDSCAPE (600px - 768px) ===== */
@media screen and (max-width: 768px) and (orientation: landscape) {
  .calendar-container { 
    padding: 10px !important; 
  }
  
  .calendar-day { 
    min-height: 55px !important; 
    padding: 4px !important; 
  }
  
  .calendar-day-header { 
    font-size: 10px !important; 
    padding: 4px 0 !important; 
  }
  
  .calendar-note-item { 
    font-size: 9px !important; 
    padding: 2px 4px !important; 
    margin-bottom: 1px !important;
  }
}

/* ===== MOBILE PORTRAIT (480px and below) ===== */
@media screen and (max-width: 480px) {
  .calendar-container { 
    padding: 8px !important; 
  }
  
  .calendar-header {
    gap: 6px !important;
  }

  .calendar-month { 
    font-size: 14px !important; 
  }
  
  .calendar-nav { 
    gap: 4px !important; 
  }
  
  .calendar-nav button { 
    padding: 5px 8px !important; 
    font-size: 11px !important; 
  }
  
  .calendar-grid { 
    gap: 2px !important; 
  }
  
  .calendar-day-header { 
    font-size: 10px !important; 
    padding: 4px 0 !important; 
    border-radius: 0;
  }
  
  .calendar-day { 
    min-height: 60px !important; 
    padding: 4px !important; 
    border-radius: 3px;
    border-width: 0.5px !important;
  }
  
  .calendar-day-number { 
    font-size: 12px !important; 
    margin-bottom: 2px !important;
  }
  
  .calendar-note-item { 
    font-size: 9px !important; 
    padding: 2px 4px !important; 
    margin-bottom: 1px !important;
    max-width: 100%;
    line-height: 1.1;
  }
}

/* ===== EXTRA SMALL MOBILE (320px) ===== */
@media screen and (max-width: 360px) {
  .calendar-container { 
    padding: 6px !important; 
  }
  
  .calendar-month { 
    font-size: 13px !important; 
  }
  
  .calendar-nav button { 
    padding: 4px 6px !important; 
    font-size: 10px !important; 
  }
  
  .calendar-grid { 
    gap: 1px !important; 
  }
  
  .calendar-day-header { 
    font-size: 9px !important; 
    padding: 2px 0 !important; 
  }
  
  .calendar-day { 
    min-height: 50px !important; 
    padding: 3px !important; 
  }
  
  .calendar-day-number { 
    font-size: 11px !important; 
    margin-bottom: 1px !important;
  }
  
  .calendar-note-item { 
    font-size: 8px !important; 
    padding: 1px 3px !important; 
    margin-bottom: 0px !important;
  }
}
  </style>
</head>

<body>
  <div id="notesTab">
    <div class="container">
      <div class="title">
        <img src="https://img.icons8.com/?size=100&id=l52olADrZLoa&format=png&color=000000"
          style="width:30px;height:30px;vertical-align:middle;margin-right:4px;" alt="All Notes">
        All Notes
      </div>

      <div class="notes-board-wrapper">
        <div class="notes-section-title">Board View</div>

        <div class="notes-boards">
          <!-- Column 1: Not Started -->
          <div class="notes-column notes-col-red">
            <div class="notes-column-header">
              <div class="notes-header-left">
                <div class="notes-status-dot notes-dot-red"></div>
                <span>Not Started</span>
                <span class="notes-count" id="notStartedCount">0</span>
              </div>
            </div>

            <div id="notStartedColumn"></div>

            <div class="notes-new-page" onclick="toggleAddForm('Not Started', this)">
              <img src="https://img.icons8.com/?size=100&id=XpyLr4ervzGM&format=png&color=000000" style="width:16px;height:16px;margin-right:6px;vertical-align:middle;" alt="plus"> New page
            </div>
            <div class="add-note-form" id="addFormNotStarted" style="display: none;">
              <div class="form-title-wrapper">
                <div class="form-title-left">
                  <img src="https://img.icons8.com/?size=100&id=ulYKuVdTiawZ&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="edit">
                  <input type="text" class="form-input" placeholder="New Title" id="titleNotStarted">
                </div>
              </div>

              <div class="form-input-wrapper">
                <img src="https://img.icons8.com/?size=100&id=tWKODv40VPFu&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="calendar">
                <input type="date" class="form-input" id="dateNotStarted">
              </div>

              <div class="form-input-wrapper">
                <img src="https://img.icons8.com/?size=100&id=t6KCtQfLNjCU&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="tag">
                <input type="text" class="form-input" placeholder="Add Tag" id="tagNotStarted">
              </div>

              <div class="form-actions">
                <button class="form-btn form-btn-save" onclick="saveQuickNote('Not Started')"><span>Save</span></button>
                <button class="form-btn form-btn-cancel" onclick="cancelAddForm('addFormNotStarted')"><span>Cancel</span></button>
              </div>
            </div>
          </div>

          <!-- Column 2: In Progress -->
          <div class="notes-column notes-col-blue">
            <div class="notes-column-header">
              <div class="notes-header-left">
                <div class="notes-status-dot notes-dot-blue"></div>
                <span>In progress</span>
                <span class="notes-count" id="inProgressCount">0</span>
              </div>
            </div>

            <div id="inProgressColumn"></div>

            <div class="notes-new-page" onclick="toggleAddForm('In progress', this)">
              <img src="https://img.icons8.com/?size=100&id=XpyLr4ervzGM&format=png&color=000000" style="width:16px;height:16px;margin-right:6px;vertical-align:middle;" alt="plus"> New page
            </div>

            <div class="add-note-form" id="addFormInprogress" style="display: none;">
              <div class="form-title-wrapper">
                <div class="form-title-left">
                  <img src="https://img.icons8.com/?size=100&id=ulYKuVdTiawZ&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="edit">
                  <input type="text" class="form-input" placeholder="New Title" id="titleInprogress">
                </div>

              </div>

              <div class="form-input-wrapper">
                <img src="https://img.icons8.com/?size=100&id=tWKODv40VPFu&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="calendar">
                <input type="date" class="form-input" id="dateInprogress">
              </div>

              <div class="form-input-wrapper">
                <img src="https://img.icons8.com/?size=100&id=t6KCtQfLNjCU&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="tag">
                <input type="text" class="form-input" placeholder="Add Tag" id="tagInprogress">
              </div>

              <div class="form-actions">
                <button class="form-btn form-btn-save" onclick="saveQuickNote('In progress')"><span>Save</span></button>
                <button class="form-btn form-btn-cancel" onclick="cancelAddForm('addFormInprogress')"><span>Cancel</span></button>
              </div>
            </div>
          </div>

          <!-- Column 3: Done -->
          <div class="notes-column notes-col-green">
            <div class="notes-column-header">
              <div class="notes-header-left">
                <div class="notes-status-dot notes-dot-green"></div>
                <span>Done</span>
                <span class="notes-count" id="doneCount">0</span>
              </div>
            </div>

            <div id="doneColumn"></div>

            <div class="notes-new-page" onclick="toggleAddForm('Done', this)">
              <img src="https://img.icons8.com/?size=100&id=XpyLr4ervzGM&format=png&color=000000" style="width:16px;height:16px;margin-right:6px;vertical-align:middle;" alt="plus"> New page
            </div>
            <div class="add-note-form" id="addFormDone" style="display: none;">
              <div class="form-title-wrapper">
                <div class="form-title-left">
                  <img src="https://img.icons8.com/?size=100&id=ulYKuVdTiawZ&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="edit">
                  <input type="text" class="form-input" placeholder="New Title" id="titleDone">
                </div>

              </div>

              <div class="form-input-wrapper">
                <img src="https://img.icons8.com/?size=100&id=tWKODv40VPFu&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="calendar">
                <input type="date" class="form-input" id="dateDone">
              </div>

              <div class="form-input-wrapper">
                <img src="https://img.icons8.com/?size=100&id=t6KCtQfLNjCU&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="tag">
                <input type="text" class="form-input" placeholder="Add Tag" id="tagDone">
              </div>

              <div class="form-actions">
                <button class="form-btn form-btn-save" onclick="saveQuickNote('Done')"><span>Save</span></button>
                <button class="form-btn form-btn-cancel" onclick="cancelAddForm('addFormDone')"><span>Cancel</span></button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Calendar Section -->
      <div class="notes-calendar-section">
        <div class="notes-calendar-title">Calendar</div>

        <div class="calendar-container">
          <div class="calendar-header">
            <div class="calendar-month" id="calendarMonth">December 2025</div>
            <div class="calendar-nav">
              <button onclick="previousMonth()">‚Üê Prev</button>
              <button onclick="nextMonth()">Next ‚Üí</button>
            </div>
          </div>

          <div class="calendar-grid" id="calendarGrid">
            <div class="loading">Loading calendar...</div>
          </div>
        </div>
      </div>

      <!-- Add/Edit Note Modal -->
      <div id="noteModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <img src="https://img.icons8.com/?size=100&id=ulYKuVdTiawZ&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="edit"> Edit Note
          </div>

          <div class="form-group">
            <label>
        <img src="https://img.icons8.com/?size=100&id=ulYKuVdTiawZ&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="edit"> New Title
      </label>
            <input type="text" id="noteTitle" placeholder="Enter note title">
          </div>

          <div class="form-group">
            <label>
        <img src="https://img.icons8.com/?size=100&id=tWKODv40VPFu&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="calendar"> Add Date
      </label>
            <input type="date" id="noteStartDate">
          </div>

          <div class="form-group">
            <label>
        <img src="https://img.icons8.com/?size=100&id=t6KCtQfLNjCU&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="tag"> Add Tag
      </label>
            <input type="text" id="noteTag" placeholder="Enter tag">
          </div>

<!-- ‡πÄ‡∏≠‡∏≤ img ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà select -->
<div class="form-input-wrapper">
  <label>
        <img src="https://img.icons8.com/?size=100&id=DHzZEuuO17eB&format=png&color=000000" 
     style="width:18px;height:18px;vertical-align:middle;" 
     alt="status" 
     class="form-input-icon">
      </label>
  <select id="noteStatus" class="form-input">
    <option value="Not Started">Not Started</option>
    <option value="In progress">In progress</option>
    <option value="Done">Done</option>
  </select>
</div>

          <div class="modal-buttons">
            <button class="btn btn-primary" onclick="saveNote()">Save</button>
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          </div>
        </div>
      </div>

      <div class="calendar-tooltip" id="tooltip"></div>

      <script>
// =============================
// Notes Board - LocalStorage CRUD
// (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ backend ‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢)
// =============================

const NOTES_STORAGE_KEY = "pmtool_notes_v1";

let notesData = [];
let currentDate = new Date();
let editingNoteId = null;

// ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô edit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ô cancel
let editingCardEl = null;

// ===== STATUS MAPPING (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö API) =====
const STATUS_MAP = {
  "NOT_STARTED": { display: "Not Started", key: "notStarted" },
  "ONGOING": { display: "In Progress", key: "inProgress" },
  "COMPLETED": { display: "Completed", key: "completed" }
};

const STATUS_REVERSE = {
  "Not Started": "NOT_STARTED",
  "In Progress": "ONGOING",
  "Completed": "COMPLETED"
};

function safeParseJSON(str, fallback) {
  try { return JSON.parse(str); } catch (_) { return fallback; }
}

function uid() {
  // ‡πÉ‡∏ä‡πâ crypto ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤) ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô fallback ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
  if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
  return "note_" + Date.now() + "_" + Math.random().toString(16).slice(2);
}

function loadFromStorage() {
  const raw = localStorage.getItem(NOTES_STORAGE_KEY);
  const data = safeParseJSON(raw || "[]", []);
  return Array.isArray(data) ? data : [];
}

function saveToStorage(list) {
  localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(list || []));
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏µ tag ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤‡πÜ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏Ñ‡∏á UI ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ)
function tagColors(tag) {
  const s = (tag || "").toString();
  let hash = 0;
  for (let i = 0; i < s.length; i++) hash = (hash * 31 + s.charCodeAt(i)) >>> 0;
  const hue = hash % 360;
  return {
    tagBgColor: `hsl(${hue} 70% 92%)`,
    tagTextColor: `hsl(${hue} 35% 28%)`,
  };
}

// =============================
// Data API (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô LocalStorage)
// ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ï‡πà‡∏≠ backend ‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏Ñ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ô object ‡∏ô‡∏µ‡πâ
// =============================
const NotesAPI = {
  getNotes() {
    const list = loadFromStorage();
    return list.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
  },

  createNote(noteData) {
    const list = loadFromStorage();
    const now = Date.now();
    const base = {
      id: uid(),
      title: "",
      startDate: "",
      endDate: "",
      status: "NOT_STARTED", // ‚úÖ FIX: ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö API
      tag: "", // ‚úÖ FIX: ‡πÑ‡∏°‡πà hardcode
      createdAt: now,
      updatedAt: now,
    };
    const colors = tagColors(noteData?.tag || "");
    const note = { ...base, ...noteData, ...colors, createdAt: now, updatedAt: now };
    list.push(note);
    saveToStorage(list);
    return { success: true, note };
  },

  updateNote(noteId, patch) {
    const list = loadFromStorage();
    const idx = list.findIndex(n => n.id === noteId);
    if (idx < 0) return { success: false, message: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ô‡πâ‡∏ï" };

    const now = Date.now();
    const next = { ...list[idx], ...patch, updatedAt: now };

    // ‡∏ñ‡πâ‡∏≤ tag ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏ï‡∏≤‡∏°
    if (patch && Object.prototype.hasOwnProperty.call(patch, "tag")) {
      Object.assign(next, tagColors(next.tag));
    }

    list[idx] = next;
    saveToStorage(list);
    return { success: true, note: next };
  },

  deleteNote(noteId) {
    const list = loadFromStorage();
    const next = list.filter(n => n.id !== noteId);
    saveToStorage(next);
    return { success: true };
  }
};

// =============================
// UI logic (‡∏Ñ‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ)
// =============================

// Toggle add note form
function toggleAddForm(status, button) {
  // ‚úÖ FIX: ‡πÉ‡∏ä‡πâ regex ‡πÅ‡∏ó‡∏ô replace ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á space
  const formId = 'addForm' + status.replace(/\s+/g, '');
  const form = document.getElementById(formId);

  if (form.style.display === 'none' || form.style.display === '') {
    // Hide all forms first
    document.querySelectorAll('.add-note-form').forEach(f => f.style.display = 'none');
    document.querySelectorAll('.notes-new-page').forEach(b => b.style.display = 'flex');

    // Show this form and hide the button
    form.style.display = 'block';
    button.style.display = 'none';

    // Set default date
    const dateInput = form.querySelector('input[type="date"]');
    if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];

    // Focus on title input
    const titleInput = form.querySelector('input[type="text"]');
    if (titleInput) titleInput.focus();
  } else {
    form.style.display = 'none';
    button.style.display = 'flex';
  }
}

function cancelAddForm(formId) {
  const form = document.getElementById(formId);
  const button = form.previousElementSibling;
  form.style.display = 'none';
  button.style.display = 'flex';

  // Clear form
  form.querySelectorAll('input').forEach(input => input.value = '');
}

function saveQuickNote(status) {
  const statusKey = status.replace(/\s+/g, ''); // ‚úÖ FIX: regex
  const title = document.getElementById('title' + statusKey).value.trim();
  const date = document.getElementById('date' + statusKey).value;
  const tag = document.getElementById('tag' + statusKey).value.trim();

  if (!title) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ô‡πâ‡∏ï');
    return;
  }

  // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å
  const finalDate = date || new Date().toISOString().split('T')[0];

  // ‚úÖ FIX: ‡πÅ‡∏õ‡∏•‡∏á display status ‡πÄ‡∏õ‡πá‡∏ô API status
  const apiStatus = STATUS_REVERSE[status] || "NOT_STARTED";

  const noteData = {
    title: title,
    startDate: finalDate,
    endDate: finalDate,
    status: apiStatus,
    tag: tag || ''
  };

  const result = NotesAPI.createNote(noteData);
  if (result.success) {
    cancelAddForm('addForm' + statusKey);
    loadNotes();
  } else {
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.message || 'unknown'));
  }
}

// Load notes (LocalStorage)
function loadNotes() {
  notesData = NotesAPI.getNotes() || [];
  renderBoard();
  renderCalendar();
}

function renderBoard() {
  // ‚úÖ FIX: ‡πÉ‡∏ä‡πâ status mapping ‡πÅ‡∏ó‡∏ô hardcoded strings
  const columns = {
    "NOT_STARTED": document.getElementById('notStartedColumn'),
    "ONGOING": document.getElementById('inProgressColumn'),
    "COMPLETED": document.getElementById('doneColumn')
  };

  const counts = { "NOT_STARTED": 0, "ONGOING": 0, "COMPLETED": 0 };

  // Clear all columns
  Object.values(columns).forEach(col => col.innerHTML = '');

  notesData.forEach(note => {
    const card = createNoteCard(note);
    const column = columns[note.status];

    if (column) {
      column.appendChild(card);
      counts[note.status]++;
    }
  });

  document.getElementById('notStartedCount').textContent = counts["NOT_STARTED"];
  document.getElementById('inProgressCount').textContent = counts["ONGOING"];
  document.getElementById('doneCount').textContent = counts["COMPLETED"];
}

function escHtml(s) {
  return (s ?? "").toString()
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function createNoteCard(note) {
  const card = document.createElement('div');
  card.className = 'notes-card';

  const bgColor = note.tagBgColor || '#E8E8E8';
  const textColor = note.tagTextColor || '#555';

  card.innerHTML = `
    <div class="notes-card-title">
      <span>${escHtml(note.title)}</span>
      <div class="notes-card-actions">
        <i onclick="editNote('${note.id}')">‚úèÔ∏è</i>
        <i onclick="deleteNoteConfirm('${note.id}')">üóëÔ∏è</i>
      </div>
    </div>
    <div class="notes-date-range">üìÖ ${escHtml(note.startDate)}</div>
    <span class="notes-tag" style="background: ${bgColor}; color: ${textColor}">
      ${escHtml(note.tag || 'Untitled')}
    </span>
  `;

  return card;
}

function openModal(status = 'NOT_STARTED') {
  editingNoteId = null;
  document.getElementById('noteTitle').value = '';
  document.getElementById('noteStartDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('noteTag').value = '';
  document.getElementById('noteStatus').value = status;
  document.getElementById('noteModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('noteModal').style.display = 'none';
  editingNoteId = null;
}

function editNote(noteId) {
  const note = notesData.find(n => n.id === noteId);
  if (!note) return;

  // Close all other edit forms
  document.querySelectorAll('.edit-note-form').forEach(f => f.remove());
  if (editingCardEl) { editingCardEl.style.display = ''; editingCardEl = null; }

  // Find the card
  const cards = document.querySelectorAll('.notes-card');
  let targetCard = null;
  cards.forEach(card => {
    const editBtn = card.querySelector('.notes-card-actions i');
    if (editBtn && editBtn.getAttribute('onclick') && editBtn.getAttribute('onclick').includes(noteId)) {
      targetCard = card;
    }
  });

  if (!targetCard) return;

  // ‚úÖ FIX: ‡πÉ‡∏ä‡πâ API status values ‡πÉ‡∏ô select options
  const displayStatus = STATUS_MAP[note.status]?.display || "Not Started";

  // Create edit form
  const editForm = document.createElement('div');
  editForm.className = 'add-note-form edit-note-form';
  editForm.style.display = 'block';
  editForm.innerHTML = `
    <div class="form-title-wrapper">
      <div class="form-title-left">
        <img src="https://img.icons8.com/?size=100&id=ulYKuVdTiawZ&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="edit" class="form-input-icon">
        <input type="text" class="form-input" placeholder="New Title" value="${escHtml(note.title)}" id="editTitle${noteId}">
      </div>
    </div>
    <div class="form-input-wrapper">
      <img src="https://img.icons8.com/?size=100&id=tWKODv40VPFu&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="calendar" class="form-input-icon">
      <input type="date" class="form-input" value="${escHtml(note.startDate)}" id="editDate${noteId}">
    </div>
    <div class="form-input-wrapper">
      <img src="https://img.icons8.com/?size=100&id=t6KCtQfLNjCU&format=png&color=000000" style="width:18px;height:18px;vertical-align:middle;" alt="tag" class="form-input-icon">
      <input type="text" class="form-input" placeholder="Add Tag" value="${escHtml(note.tag)}" id="editTag${noteId}">
    </div>
    <div class="form-input-wrapper">
      <select class="form-input" id="editStatus${noteId}">
        <option value="NOT_STARTED" ${note.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
        <option value="ONGOING" ${note.status === 'ONGOING' ? 'selected' : ''}>In Progress</option>
        <option value="COMPLETED" ${note.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
      </select>
    </div>
    <div class="form-actions">
      <button class="form-btn form-btn-save" onclick="saveEditedNote('${noteId}')"><span>Save</span></button>
      <button class="form-btn form-btn-cancel" onclick="cancelEdit()"><span>Cancel</span></button>
    </div>
  `;

  // Insert after the card
  editingCardEl = targetCard;
  targetCard.style.display = 'none';
  targetCard.parentNode.insertBefore(editForm, targetCard.nextSibling);
}

function saveEditedNote(noteId) {
  const titleEl = document.getElementById('editTitle' + noteId);
  const dateEl = document.getElementById('editDate' + noteId);
  const tagEl = document.getElementById('editTag' + noteId);
  const statusEl = document.getElementById('editStatus' + noteId);

  if (!titleEl || !dateEl || !tagEl || !statusEl) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (DOM) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
    return;
  }

  const title = titleEl.value.trim();
  const startDate = dateEl.value;
  const tag = tagEl.value.trim();
  const status = statusEl.value; // ‚úÖ Already API format

  if (!title || !startDate) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
    return;
  }

  const noteData = {
    title: title,
    startDate: startDate,
    endDate: startDate,
    status: status,
    tag: tag || ''
  };

  const result = NotesAPI.updateNote(noteId, noteData);
  if (result && result.success) {
    cancelEdit();
    loadNotes();
  } else {
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result?.message || 'unknown'));
  }
}

function cancelEdit() {
  const editForm = document.querySelector('.edit-note-form');
  if (editForm) editForm.remove();

  if (editingCardEl) {
    editingCardEl.style.display = '';
    editingCardEl = null;
  }
}

function saveNote() {
  const title = document.getElementById('noteTitle').value.trim();
  const startDate = document.getElementById('noteStartDate').value;
  const tag = document.getElementById('noteTag').value.trim();
  const status = document.getElementById('noteStatus').value;

  if (!title || !startDate) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
    return;
  }

  const noteData = {
    title: title,
    startDate: startDate,
    endDate: startDate,
    status: status,
    tag: tag || ''
  };

  if (editingNoteId) {
    const result = NotesAPI.updateNote(editingNoteId, noteData);
    if (result.success) {
      closeModal();
      loadNotes();
    } else {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.message || 'unknown'));
    }
  } else {
    closeModal();
  }
}

function deleteNoteConfirm(noteId) {
  if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Note ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
    const result = NotesAPI.deleteNote(noteId);
    if (result.success) {
      loadNotes();
    } else {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.message || 'unknown'));
    }
  }
}

// ‚úÖ FIX: ‡πÉ‡∏ä‡πâ API status values
function getStatusColor(status) {
  const colorMap = {
    "NOT_STARTED": "calendar-note-red",
    "ONGOING": "calendar-note-blue",
    "COMPLETED": "calendar-note-green"
  };
  return colorMap[status] || "calendar-note-red";
}

function renderCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  const monthNames = ["January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"];

  document.getElementById("calendarMonth").textContent = `${monthNames[month]} ${year}`;

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startDayOfWeek = firstDay.getDay();
  const prevMonthLastDay = new Date(year, month, 0).getDate();

  const grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";

  const tooltip = document.getElementById("tooltip");

  const dayHeaders = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
  dayHeaders.forEach(day => {
    const header = document.createElement("div");
    header.className = "calendar-day-header";
    header.textContent = day;
    grid.appendChild(header);
  });

  for (let i = startDayOfWeek - 1; i >= 0; i--) {
    const day = document.createElement("div");
    day.className = "calendar-day other-month";
    day.innerHTML = `<div class="calendar-day-number">${prevMonthLastDay - i}</div>`;
    grid.appendChild(day);
  }

  const today = new Date();
  for (let i = 1; i <= daysInMonth; i++) {
    const day = document.createElement("div");
    day.className = "calendar-day";

    if (year === today.getFullYear() &&
      month === today.getMonth() &&
      i === today.getDate()) {
      day.classList.add("today");
    }

    const dayNumber = document.createElement("div");
    dayNumber.className = "calendar-day-number";
    dayNumber.textContent = i;
    day.appendChild(dayNumber);

    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
    const dayNotes = notesData.filter(note =>
      note.startDate === dateStr || note.endDate === dateStr
    );

    dayNotes.forEach(note => {
      const noteItem = document.createElement("div");
      noteItem.className = `calendar-note-item ${getStatusColor(note.status)}`;
      noteItem.textContent = note.tag || "Note";

      noteItem.addEventListener("mouseenter", function () {
        tooltip.innerHTML = `
          <strong>${escHtml(note.title)}</strong><br>
          <span style="display:inline-flex;align-items:center;gap:4px;">
            <img src="https://img.icons8.com/?size=100&id=t6KCtQfLNjCU&format=png&color=000000" style="width:12px;height:12px;"> ${escHtml(note.tag || 'Untitled')}
          </span><br>
          <span style="display:inline-flex;align-items:center;gap:4px;">
            <img src="https://img.icons8.com/?size=100&id=tWKODv40VPFu&format=png&color=000000" style="width:12px;height:12px;"> ${escHtml(note.startDate)}
          </span>
        `;

        const rect = this.getBoundingClientRect();
        tooltip.style.left = (rect.left + rect.width / 2) + "px";
        tooltip.style.top = (rect.top - 10) + "px";
        tooltip.style.transform = "translate(-50%, -100%)";
        tooltip.classList.add("show");
      });

      noteItem.addEventListener("mouseleave", function () {
        tooltip.classList.remove("show");
      });

      noteItem.addEventListener("click", function (e) {
        e.stopPropagation();
        editNote(note.id);
      });

      day.appendChild(noteItem);
    });

    grid.appendChild(day);
  }

  const totalCells = grid.children.length - 7;
  const remainingCells = 42 - totalCells - 7;
  for (let i = 1; i <= remainingCells; i++) {
    const day = document.createElement("div");
    day.className = "calendar-day other-month";
    day.innerHTML = `<div class="calendar-day-number">${i}</div>`;
    grid.appendChild(day);
  }
}

function previousMonth() {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar();
}

function nextMonth() {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar();
}

window.onclick = function (event) {
  const modal = document.getElementById('noteModal');
  if (event.target === modal) closeModal();
}

// ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å onclick ‡πÑ‡∏î‡πâ (‡∏Å‡∏£‡∏ì‡∏µ browser strict)
Object.assign(window, {
  toggleAddForm,
  cancelAddForm,
  saveQuickNote,
  loadNotes,
  renderBoard,
  renderCalendar,
  openModal,
  closeModal,
  editNote,
  saveEditedNote,
  cancelEdit,
  saveNote,
  deleteNoteConfirm,
  previousMonth,
  nextMonth
});

// Initialize
loadNotes();
</script>
</body>


</html>