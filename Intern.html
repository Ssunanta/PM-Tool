<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Intern Management</title>

  <style>
    .intern-wrapper {
      --bg: #f3f3f3;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 10px 28px rgba(15, 23, 42, .10);
      --shadow2: 0 4px 12px rgba(15, 23, 42, .08);
      --radius: 16px;
      --radius2: 12px;
      --btn: #111;
      --btnHover: #000;
      --purple: #8b5cf6;
    }

    .intern-wrapper * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .intern-wrapper {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      -webkit-text-size-adjust: 100%;
    }

    .intern-wrapper .container {
      max-width: 1280px;
      margin: 0 auto 20px;
      padding: 22px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .intern-wrapper .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 24px;
      font-weight: 900;
      letter-spacing: .2px;
      margin-bottom: 14px;
    }

    .intern-wrapper .title .dot {
      width: 14px;
      height: 14px;
      border-radius: 5px;
      background: var(--purple);
      box-shadow: 0 6px 16px rgba(139, 92, 246, .35);
      display: inline-block;
    }

    .intern-wrapper .intern-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
      padding: 14px;
      background: #f8fafc;
      border: 1px solid rgba(15, 23, 42, .08);
      border-radius: 16px;
      box-shadow: var(--shadow2);
    }

    .intern-wrapper .intern-controls input {
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      font-weight: 900;
      box-shadow: 0 6px 16px rgba(15, 23, 42, .06);
      flex: 1 1 200px;
      min-width: 200px;
    }

    .intern-wrapper .intern-controls input::placeholder {
      color: #94a3b8;
      font-weight: 900;
    }

    .intern-wrapper .intern-controls input:focus {
      outline: none;
      border-color: #111;
      box-shadow: 0 10px 22px rgba(15, 23, 42, .10);
    }

    .intern-wrapper .intern-controls button {
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: 900;
      box-shadow: 0 6px 16px rgba(15, 23, 42, .06);
      transition: 0.2s;
      white-space: nowrap;
      flex: 0 1 auto;
      min-width: fit-content;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .intern-wrapper .intern-controls button:hover {
      border-color: #cbd5e1;
      background: #fafafa;
    }

    .intern-wrapper .manage-btn {
      height: 44px;
      padding: 0 18px;
      border-radius: 14px;
      border: none;
      background: var(--btn);
      color: #fff;
      font-size: 14px;
      font-weight: 900;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: var(--shadow2);
      white-space: nowrap;
      opacity: 1;
      flex: 0 1 auto;
      min-width: fit-content;
      -webkit-appearance: none;
      appearance: none;
      -webkit-text-fill-color: #fff;
      text-rendering: geometricPrecision;
    }

    .intern-wrapper .manage-btn span {
      color: #fff;
      -webkit-text-fill-color: #fff;
      font-weight: inherit;
    }

    .intern-wrapper .manage-btn:hover {
      background: var(--btnHover);
    }

    .intern-wrapper .manage-btn.active {
      background: #10b981;
    }

    .intern-wrapper .intern-controls .manage-btn {
      background: var(--btn);
      color: #fff;
      border: none;
    }

    .intern-wrapper .intern-controls .manage-btn:hover {
      background: var(--btnHover);
      color: #fff;
      border: none;
    }

    .intern-wrapper .intern-controls .manage-btn.active {
      background: #10b981;
      color: #fff;
    }

    .intern-wrapper .intern-controls button:last-child {
      background: #fff;
      border: 1px solid rgba(15, 23, 42, .16);
    }

    .intern-wrapper .intern-controls button:last-child:hover {
      background: #f1f5f9;
      border-color: rgba(15, 23, 42, .22);
    }

    .intern-wrapper .intern-controls select {
      display: none !important;
    }

    .intern-wrapper .custom-dropdown-intern {
      position: relative;
      flex: 0 1 auto;
      width: 260px;
      min-width: 180px;
      max-width: 260px;
    }

    .intern-wrapper .dropdown-selected-intern {
      padding: 12px 14px;
      border-radius: 14px;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border: 1px solid var(--border);
      font-size: 14px;
      font-weight: 900;
      box-shadow: var(--shadow2);
      width: 100%;
      height: 44px;
      gap: 10px;
    }

    .intern-wrapper #selectedPositionText {
      display: block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: calc(100% - 24px);
    }

    .intern-wrapper .dropdown-selected-intern:hover {
      border-color: #cbd5e1;
    }

    .intern-wrapper .dropdown-items-intern {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: #f1f5f9;
      border: 1px solid var(--border);
      border-radius: 16px;
      margin-top: 8px;
      max-height: 360px;
      overflow-y: auto;
      display: none;
      z-index: 100;
      padding: 10px;
      box-shadow: var(--shadow);
    }

    .intern-wrapper .dropdown-items-intern.open {
      display: block;
    }

    .intern-wrapper .dd-item-intern {
      display: block;
      padding: 12px 12px;
      border-radius: 14px;
      cursor: pointer;
      font-size: 15px;
      color: #111;
      border: 1px solid rgba(15, 23, 42, .06);
      background: #fff;
      font-weight: 900;
      white-space: normal;
      word-break: normal;
      overflow-wrap: anywhere;
      line-height: 1.25;
    }

    .intern-wrapper .dd-item-intern+.dd-item-intern {
      margin-top: 8px;
    }

    .intern-wrapper .dd-item-intern:hover {
      background: #fafafa;
      border-color: rgba(15, 23, 42, .12);
    }

    .intern-wrapper .status-dd {
      position: relative;
      display: inline-block;
      width: 140px;
    }

    .intern-wrapper .status-selected {
      height: 36px;
      padding: 0 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
      box-shadow: var(--shadow2);
      font-size: 13px;
      font-weight: 900;
      user-select: none;
    }

    .intern-wrapper .status-selected:hover {
      border-color: #cbd5e1;
      background: #fafafa;
    }

    .intern-wrapper .status-items {
      position: fixed;
      margin-top: 6px;
      background: #f1f5f9;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 8px;
      display: none;
      z-index: 250;
      box-shadow: var(--shadow);
      min-width: 140px;
    }

    .intern-wrapper .status-items.open {
      display: block;
    }

    .intern-wrapper .status-item {
      padding: 10px 10px;
      border-radius: 12px;
      background: #fff;
      cursor: pointer;
      text-align: center;
      border: 1px solid rgba(15, 23, 42, .06);
      font-size: 13px;
      font-weight: 900;
    }

    .intern-wrapper .status-item+.status-item {
      margin-top: 8px;
    }

    .intern-wrapper .status-item:hover {
      background: #fafafa;
      border-color: rgba(15, 23, 42, .12);
    }

    .intern-wrapper .table-wrap {
      margin-top: 8px;
      border: 1px solid var(--border);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: var(--shadow2);
      background: #fff;
      display: flex;
      flex-direction: column;
      max-height: 100vh;
    }

    .intern-wrapper .table-header-wrapper {
      overflow-x: auto;
      overflow-y: hidden;
      flex-shrink: 0;
      scrollbar-width: none;
    }

    .intern-wrapper .table-header-wrapper::-webkit-scrollbar {
      height: 0;
    }

    .intern-wrapper .table-body-wrapper {
      overflow-y: auto;
      overflow-x: auto;
      flex: 1;
      -webkit-overflow-scrolling: touch;
    }

    .intern-wrapper table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
      min-width: 1020px;
    }

    .intern-wrapper table thead th {
      background: #f8fafc;
      font-weight: 900;
      color: #111827;
      border-bottom: 1px solid var(--border);
      padding: 14px;
      font-size: 14px;
      text-align: center;
      vertical-align: middle;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .intern-wrapper table tbody td {
      padding: 14px;
      font-size: 14px;
      border-bottom: 1px solid rgba(15, 23, 42, .06);
      text-align: center;
      vertical-align: middle;
      color: #333;
    }

    .intern-wrapper table tbody tr:nth-child(odd) {
      background: #fff;
    }

    .intern-wrapper table tbody tr:nth-child(even) {
      background: #fcfcfd;
    }

    .intern-wrapper table tbody tr:hover {
      background: #f7fafc;
    }

    .intern-wrapper table input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--btn);
    }

    .intern-wrapper table select {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 900;
      cursor: pointer;
      background: #fff;
      box-shadow: var(--shadow2);
    }

    .intern-wrapper table select:focus {
      outline: none;
      border-color: var(--btn);
      box-shadow: 0 10px 22px rgba(15, 23, 42, .10);
    }

    .intern-wrapper .delete-btn {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(239, 68, 68, .35);
      background: #fff1f2;
      color: #b91c1c;
      cursor: pointer;
      font-size: 12px;
      font-weight: 900;
      transition: 0.2s;
    }

    .intern-wrapper .delete-btn:hover {
      filter: brightness(.95);
    }

    .intern-wrapper a {
      color: #1a73e8;
      text-decoration: none;
    }

    .intern-wrapper a:hover {
      text-decoration: underline;
    }

    .intern-wrapper .loading {
      text-align: center;
      padding: 50px;
      color: #999;
      font-weight: 900;
    }

    .intern-wrapper .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      font-weight: 900;
      margin: 20px 0 16px 0;
      color: #111827;
      letter-spacing: .2px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .intern-wrapper .h3-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .intern-wrapper .section-header button {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 13px;
      font-weight: 900;
      box-shadow: var(--shadow2);
      transition: 0.2s;
      white-space: nowrap;
    }

    .intern-wrapper .section-header button:hover {
      border-color: #cbd5e1;
      background: #fafafa;
    }

    .intern-wrapper #startingAddForm,
    .intern-wrapper #endingAddForm,
    .intern-wrapper #addInternForm {
      display: none;
      gap: 10px;
      align-items: center;
      margin-top: 14px;
      padding: 14px;
      background: #f8fafc;
      border-radius: 12px;
      flex-wrap: wrap;
      border: 1px solid rgba(15, 23, 42, .08);
    }

    .intern-wrapper #startingAddForm.show,
    .intern-wrapper #endingAddForm.show,
    .intern-wrapper #addInternForm.show {
      display: flex;
    }

    .intern-wrapper #startingAddForm input,
    .intern-wrapper #endingAddForm input,
    .intern-wrapper #addInternForm input {
      height: 44px;
      padding: 0 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 13px;
      font-weight: 900;
      box-shadow: var(--shadow2);
      flex: 1;
      min-width: 160px;
      background: #fff;
    }

    .intern-wrapper #startingAddForm input:focus,
    .intern-wrapper #endingAddForm input:focus,
    .intern-wrapper #addInternForm input:focus {
      outline: none;
      border-color: var(--btn);
      box-shadow: 0 10px 22px rgba(15, 23, 42, .10);
    }

    .intern-wrapper #startingAddForm button,
    .intern-wrapper #endingAddForm button,
    .intern-wrapper #addInternForm button {
      height: 44px;
      padding: 0 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 13px;
      font-weight: 900;
      box-shadow: var(--shadow2);
      transition: 0.2s;
      white-space: nowrap;
    }

    .intern-wrapper #startingAddForm button:hover,
    .intern-wrapper #endingAddForm button:hover,
    .intern-wrapper #addInternForm button:hover {
      background: #f7f7f7;
      border-color: #cbd5e1;
    }

    @media (max-width: 1200px) {
      .intern-wrapper .container {
        padding: 20px;
      }

      .intern-wrapper .intern-controls {
        flex-wrap: wrap;
      }

      .intern-wrapper .intern-controls input {
        flex: 1 1 auto;
        min-width: 160px;
      }

      .intern-wrapper .custom-dropdown-intern {
        width: 220px;
        min-width: 220px;
        max-width: 220px;
      }

      .intern-wrapper #internManageBtn,
      .intern-wrapper .intern-controls button:last-child {
        flex: 0 0 auto;
      }

      .intern-wrapper table {
        min-width: 1000px;
      }
    }

    @media (max-width: 920px) {
      .intern-wrapper .container {
        padding: 18px;
        margin: 0 auto 18px;
      }

      .intern-wrapper .title {
        font-size: 22px;
      }

      .intern-wrapper .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .intern-wrapper .h3-actions {
        width: 100%;
        justify-content: flex-start;
      }

      .intern-wrapper .intern-controls {
        padding: 12px;
        flex-direction: column;
      }

      .intern-wrapper .intern-controls input {
        width: 100%;
        order: 1;
      }

      .intern-wrapper .custom-dropdown-intern {
        width: 100%;
        max-width: none;
        order: 2;
      }

      .intern-wrapper #internManageBtn {
        width: 100%;
        order: 3;
      }

      .intern-wrapper .intern-controls button:last-child {
        width: 100%;
        order: 4;
      }

      .intern-wrapper table th,
      .intern-wrapper table td {
        padding: 12px 10px;
        font-size: 13px;
      }

      .intern-wrapper .table-wrap {
        max-height: 500px;
      }
    }

    @media (max-width: 768px) {
      .intern-wrapper .container {
        padding: 16px;
        border-radius: 14px;
      }

      .intern-wrapper .title {
        font-size: 20px;
        margin-bottom: 12px;
      }

      .intern-wrapper .intern-controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 12px;
      }

      .intern-wrapper .intern-controls input {
        width: 100%;
        height: 48px;
        font-size: 15px;
        order: 1;
      }

      .intern-wrapper .custom-dropdown-intern {
        width: 100%;
        order: 2;
      }

      .intern-wrapper .dropdown-selected-intern {
        height: 48px;
        font-size: 15px;
      }

      .intern-wrapper #internManageBtn {
        width: 100%;
        height: 48px;
        font-size: 15px;
        order: 3;
      }

      .intern-wrapper .intern-controls button:last-child {
        width: 100%;
        height: 48px;
        font-size: 15px;
        order: 4;
      }

      .intern-wrapper .status-dd {
        width: 130px;
      }

      .intern-wrapper .table-wrap {
        max-height: 450px;
      }

      .intern-wrapper #startingAddForm,
      .intern-wrapper #endingAddForm,
      .intern-wrapper #addInternForm {
        padding: 12px;
        gap: 8px;
      }

      .intern-wrapper #startingAddForm input,
      .intern-wrapper #endingAddForm input,
      .intern-wrapper #addInternForm input {
        min-width: 140px;
        height: 48px;
        font-size: 15px;
      }

      .intern-wrapper #startingAddForm button,
      .intern-wrapper #endingAddForm button,
      .intern-wrapper #addInternForm button {
        height: 48px;
        font-size: 15px;
      }

      .intern-wrapper .section-header button {
        height: 44px;
        font-size: 14px;
        padding: 0 16px;
      }
    }

    @media (max-width: 480px) {
      .intern-wrapper .container {
        padding: 14px;
        margin: 0 auto 16px;
      }

      .intern-wrapper .title {
        font-size: 20px;
        margin-bottom: 14px;
      }

      .intern-wrapper .intern-controls {
        padding: 12px;
        gap: 10px;
      }

      .intern-wrapper .intern-controls input {
        height: 52px;
        font-size: 17px;
      }

      .intern-wrapper .intern-controls button,
      .intern-wrapper .manage-btn {
        height: 52px;
        font-size: 17px;
      }

      .intern-wrapper .section-header {
        font-size: 17px;
        margin: 18px 0 12px 0;
      }

      .intern-wrapper table {
        min-width: 880px;
      }

      .intern-wrapper table thead th {
        font-size: 12px;
        padding: 10px 6px;
      }

      .intern-wrapper table tbody td {
        padding: 10px 6px;
        font-size: 12px;
      }
    }
  </style>

</head>

<body>

  <!-- MAIN INTERN DATA -->
  <div class="intern-wrapper">
    <div class="container">
      <div class="title">
        <img src="https://img.icons8.com/?size=100&id=wNJfNKpLXXlt&format=png&color=000000" alt="users"
          style="width:24px;height:24px;">
        รายชื่อเด็กฝึกงาน
      </div>

      <div class="intern-controls">
        <input type="text" id="internSearch" placeholder="ค้นหาชื่อ" oninput="filterInterns()" />

        <button id="internManageBtn" class="manage-btn" onclick="toggleInternManageMode()">
          <img src="https://img.icons8.com/?size=100&id=bDKqvw7V0ANQ&format=png&color=000000" alt="plus"
            style="width:16px;height:16px;">
          <span>เพิ่ม/ลดรายชื่อ</span>
        </button>

        <div class="custom-dropdown-intern">
          <div class="dropdown-selected-intern" id="positionDropdownToggle" onclick="togglePositionDropdown()">
            <span id="selectedPositionText">ตำแหน่งทั้งหมด</span>
            <span>▾</span>
          </div>
          <div class="dropdown-items-intern" id="positionDropdownItems">
            <div class="dd-item-intern" onclick="selectPosition('', 'ตำแหน่งทั้งหมด')">ตำแหน่งทั้งหมด</div>
          </div>
        </div>

        <button onclick="clearInternFilters()">
          ล้างตัวกรอง
        </button>
      </div>

      <div class="table-wrap">
        <div class="table-header-wrapper">
          <table>
            <!-- Table Header -->
            <colgroup>
              <col style="width:120px;"> <!-- ชื่อ -->
              <col style="width:150px;"> <!-- ตำแหน่ง -->
              <col style="width:70px;"> <!-- เช้า -->
              <col style="width:70px;"> <!-- บ่าย -->
              <col style="width:140px;"> <!-- สถานะ -->
              <col style="width:200px;"> <!-- หมายเหตุ -->
              <col style="width:180px;"> <!-- ไฟล์อัปเดตงาน -->
              <col id="internActionsHeaderCol" style="width:100px; display:none;"> <!-- ลบ -->
            </colgroup>
            <thead>
              <tr>
                <th>ชื่อ</th>
                <th>ตำแหน่ง</th>
                <th>เช้า</th>
                <th>บ่าย</th>
                <th>สถานะ</th>
                <th>หมายเหตุ</th>
                <th>ไฟล์อัปเดตงาน</th>
                <th id="internActionsHeader" style="display:none;">ลบ</th>
              </tr>
            </thead>
          </table>
        </div>

        <div class="table-body-wrapper">
          <table>
            <colgroup>
              <col style="width:120px;"> <!-- ชื่อ -->
              <col style="width:150px;"> <!-- ตำแหน่ง -->
              <col style="width:70px;"> <!-- เช้า -->
              <col style="width:70px;"> <!-- บ่าย -->
              <col style="width:140px;"> <!-- สถานะ -->
              <col style="width:200px;"> <!-- หมายเหตุ -->
              <col style="width:180px;"> <!-- ไฟล์อัปเดตงาน -->
              <col id="internActionsBodyCol" style="width:100px; display:none;"> <!-- ลบ -->
            </colgroup>

            <tbody id="internTableBody">
              <tr>
                <td colspan="7" class="loading">กำลังโหลด...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ✅ เพิ่มฟอร์ม inline สำหรับเพิ่มเด็กฝึกงาน -->
      <div id="addInternForm">
        <input type="text" id="newInternName" placeholder="ชื่อเด็กฝึกงาน">
        <input type="text" id="newInternPosition" placeholder="ตำแหน่ง" list="addInternPositionDatalist">
        <datalist id="addInternPositionDatalist"></datalist>
        <input type="text" id="newInternNote" placeholder="หมายเหตุ (ไม่บังคับ)">
        <input type="text" id="newInternFileLink" placeholder="ลิงก์ไฟล์อัปเดตงาน (ไม่บังคับ)">
        <button onclick="addNewInternSubmit()">
          <img src="https://img.icons8.com/?size=100&id=0YcjyJq4ROPU&format=png&color=000000" alt="check"
            style="width:16px;height:16px;">
          เพิ่ม
        </button>
        <button onclick="hideAddInternForm()">
          <img src="https://img.icons8.com/?size=100&id=QlMnqMXDMws3&format=png&color=000000" alt="close"
            style="width:16px;height:16px;">
          ยกเลิก
        </button>
      </div>

    </div>

    <!-- STARTING -->
    <div class="container">
      <div class="section-header">
        <span>
          <img src="https://img.icons8.com/?size=100&id=WO3eRAu5RSGP&format=png&color=000000" alt="sprout"
            style="width:20px;height:20px;">
          นักศึกษาฝึกงานที่กำลังเริ่มงาน
        </span>
        <div class="h3-actions">
          <button onclick="toggleStartingAdd()">
            <img src="https://img.icons8.com/?size=100&id=XpyLr4ervzGM&format=png&color=000000" alt="add"
              style="width:14px;height:14px;">
            เพิ่มชื่อ
          </button>
          <button id="editStartingBtn" onclick="toggleEditStarting()">
            <img src="https://img.icons8.com/?size=100&id=ulYKuVdTiawZ&format=png&color=000000" alt="edit"
              style="width:14px;height:14px;">
            แก้ไข
          </button>
        </div>
      </div>

      <div class="table-wrap">
        <div class="table-header-wrapper">
          <table>
            <thead>
              <tr>
                <th>ชื่อจริง/นามสกุล</th>
                <th>ชื่อเล่น</th>
                <th>ตำแหน่ง</th>
                <th>วันที่</th>
                <th>แจ้ง</th>
                <th id="startingActionCol" style="display:none;">ลบ</th>
              </tr>
            </thead>
          </table>
        </div>
        <div class="table-body-wrapper">
          <table>
            <tbody id="internStartingBody">
              <tr>
                <td colspan="5" class="loading">กำลังโหลด...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="startingAddForm">
        <input type="text" id="startingFullName" placeholder="ชื่อจริง/นามสกุล">
        <input type="text" id="startingNickName" placeholder="ชื่อเล่น">
        <input type="text" id="startingPosition" placeholder="ตำแหน่ง">
        <input type="text" id="startingDate" placeholder="วันที่/ช่วงเวลา (เช่น 01/01/2026)">
        <button onclick="addStartingIntern()">
          <img src="https://img.icons8.com/?size=100&id=0YcjyJq4ROPU&format=png&color=000000" alt="check"
            style="width:16px;height:16px;">
          เพิ่ม
        </button>
        <button onclick="toggleStartingAdd()">
          <img src="https://img.icons8.com/?size=100&id=QlMnqMXDMws3&format=png&color=000000" alt="close"
            style="width:16px;height:16px;">
          ยกเลิก
        </button>
      </div>
    </div>

    <!-- ENDING -->
    <div class="container">
      <div class="section-header">
        <span>
          <img src="https://img.icons8.com/?size=100&id=XVGCqo0GC6fq&format=png&color=000000" alt="hourglass"
            style="width:20px;height:20px;">
          นักศึกษาฝึกงานใกล้จบการฝึกงาน
        </span>
        <div class="h3-actions">
          <button onclick="toggleEndingAdd()">
            <img src="https://img.icons8.com/?size=100&id=XpyLr4ervzGM&format=png&color=000000" alt="add"
              style="width:14px;height:14px;">
            เพิ่มชื่อ
          </button>
          <button id="editEndingBtn" onclick="toggleEditEnding()">
            <img src="https://img.icons8.com/?size=100&id=ulYKuVdTiawZ&format=png&color=000000" alt="edit"
              style="width:14px;height:14px;">
            แก้ไข
          </button>
        </div>
      </div>

      <div class="table-wrap">
        <div class="table-header-wrapper">
          <table>
            <thead>
              <tr>
                <th>ชื่อจริง/นามสกุล</th>
                <th>ชื่อเล่น</th>
                <th>ตำแหน่ง</th>
                <th>วันที่</th>
                <th>แจ้ง</th>
                <th id="endingActionCol" style="display:none;">ลบ</th>
              </tr>
            </thead>
          </table>
        </div>
        <div class="table-body-wrapper">
          <table>
            <tbody id="internEndingBody">
              <tr>
                <td colspan="5" class="loading">กำลังโหลด...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="endingAddForm">
        <input type="text" id="endingFullName" placeholder="ชื่อจริง/นามสกุล">
        <input type="text" id="endingNickName" placeholder="ชื่อเล่น">
        <input type="text" id="endingPosition" placeholder="ตำแหน่ง">
        <input type="text" id="endingDate" placeholder="วันที่/ช่วงเวลา">
        <button onclick="addEndingIntern()">
          <img src="https://img.icons8.com/?size=100&id=0YcjyJq4ROPU&format=png&color=000000" alt="check"
            style="width:16px;height:16px;">
          เพิ่ม
        </button>
        <button onclick="toggleEndingAdd()">
          <img src="https://img.icons8.com/?size=100&id=QlMnqMXDMws3&format=png&color=000000" alt="close"
            style="width:16px;height:16px;">
          ยกเลิก
        </button>
      </div>
    </div>

    <script>
      /* API Adapter - PM Project API */
      (function initBackendAdapter() {
        const API_BASE = "http://localhost:3000";

        window.BACKEND = {
          async getInternData(page = 1, limit = 100, search = "", role = "") {
            try {
              console.log("[API] getInternData called with:", { page, limit, search, role });
              const all = [];
              let p = Number(page || 1);
              const lim = Number(limit || 100);

              while (true) {
                const params = new URLSearchParams();
                params.set("page", String(p));
                params.set("limit", String(lim));
                if (search && String(search).trim()) params.set("search", String(search).trim());
                if (role && String(role).trim()) params.set("role", String(role).trim());

                const url = `${API_BASE}/members?${params.toString()}`;
                console.log("[API] Fetching:", url);

                const res = await fetch(url, {
                  method: "GET",
                  headers: { "Accept": "application/json" },
                  credentials: "same-origin"
                });

                if (!res.ok) {
                  const txt = await res.text().catch(() => "");
                  console.error("[API] GET /members failed:", res.status, txt);
                  // ❌ อย่าวนลูปต่อเมื่อ backend ตอบ 400/500
                  break;
                }

                const data = await res.json().catch(() => ({}));
                console.log("[API] Response data:", data);

                const items = Array.isArray(data?.data) ? data.data : (Array.isArray(data) ? data : []);
                all.push(...items);

                const totalPages = Number(data?.pagination?.totalPages || 1);
                if (p >= totalPages) break;
                p += 1;
              }

              console.log("[API] getInternData completed, total items:", all.length);
              return { items: all, pagination: { loadedAll: true } };
            } catch (err) {
              console.error("[API] โหลด interns ไม่สำเร็จ:", err);
              return { items: [], pagination: {} };
            }
          },

          async getInternStarting() {
            try {
              const res = await fetch(`${API_BASE}/events?search=starting&limit=100`, { method: "GET" });
              if (!res.ok) return [];
              const data = await res.json();
              return (data.data || []).filter(e => e.tags && e.tags.includes("starting"));
            } catch (err) {
              return [];
            }
          },

          async getInternEnding() {
            try {
              const res = await fetch(`${API_BASE}/events?search=ending&limit=100`, { method: "GET" });
              if (!res.ok) return [];
              const data = await res.json();
              return (data.data || []).filter(e => e.tags && e.tags.includes("ending"));
            } catch (err) {
              return [];
            }
          },

          async saveInternStarting(payload) {
            try {
              for (const item of payload) {
                const eventData = {
                  title: `${item.fullName} เริ่มงาน`,
                  description: `ตำแหน่ง: ${item.position}, วันที่: ${item.dateRange}`,
                  tags: ["starting", item.position],
                  start: new Date().toISOString(),
                  status: item.notifyStatus ? "COMPLETED" : "NOT_STARTED"
                };

                await fetch(`${API_BASE}/events`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(eventData)
                });
              }
              return { success: true };
            } catch (err) {
              console.error("saveInternStarting error:", err);
              return { success: false, message: err.message };
            }
          },

          async saveInternEnding(payload) {
            try {
              for (const item of payload) {
                const eventData = {
                  title: `${item.fullName} จบงาน`,
                  description: `ตำแหน่ง: ${item.position}, วันที่: ${item.dateRange}`,
                  tags: ["ending", item.position],
                  start: new Date().toISOString(),
                  status: item.notifyStatus ? "COMPLETED" : "NOT_STARTED"
                };

                await fetch(`${API_BASE}/events`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(eventData)
                });
              }
              return { success: true };
            } catch (err) {
              console.error("saveInternEnding error:", err);
              return { success: false, message: err.message };
            }
          },

          async addNewIntern(name, position, note, fileLink) {
            try {
              // ✅ Backend หลายตัว "ต้องการ role" และอาจไม่รู้จัก field fileLink
              // เราเลยส่งเฉพาะ field มาตรฐาน + role intern
              const basePayload = {
                displayName: name,
                position: position,
                note: note,
                role: "intern"
              };

              const attempts = [
                basePayload,
                { ...basePayload, role: "INTERN" },
                { ...basePayload, role: "Intern" }
              ];

              let lastTxt = "";

              for (const payload of attempts) {
                const res = await fetch(`${API_BASE}/members`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json", "Accept": "application/json" },
                  body: JSON.stringify(payload)
                });

                if (res.ok) {
                  const created = await res.json().catch(() => ({}));

                  // ✅ เก็บ fileLink ไว้ local ต่อ memberId (ไม่พัง DTO ฝั่ง backend)
                  const id = String(created?._id || created?.id || "");
                  if (id && fileLink && String(fileLink).trim()) {
                    writeMeta(id, { fileLink: String(fileLink).trim() });
                  }
                  return { success: true, created };
                }

                lastTxt = await res.text().catch(() => "");
                console.error("POST /members failed:", res.status, lastTxt);
              }

              return { success: false, message: lastTxt || "เพิ่มไม่สำเร็จ" };
            } catch (err) {
              return { success: false, message: err.message };
            }
          },

          async updateIntern(memberId, name, position, note, fileLink) {
            try {
              const memberData = {
                displayName: name,
                position: position,
                note: note
              };

              const res = await fetch(`${API_BASE}/members/${memberId}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json", "Accept": "application/json" },
                body: JSON.stringify(memberData)
              });

              if (!res.ok) {
                const txt = await res.text().catch(() => "");
                console.error("PATCH /members/:id failed:", res.status, txt);
                return { success: false, message: txt || "อัปเดตไม่สำเร็จ" };
              }

              // ✅ fileLink เก็บ local
              if (fileLink && String(fileLink).trim()) {
                writeMeta(String(memberId), { fileLink: String(fileLink).trim() });
              } else {
                writeMeta(String(memberId), { fileLink: "" });
              }

              return { success: true };
            } catch (err) {
              return { success: false, message: err.message };
            }
          },

          async deleteIntern(memberId) {
            try {
              const res = await fetch(`${API_BASE}/members/${memberId}`, {
                method: "DELETE",
                headers: { "Content-Type": "application/json" }
              });

              if (!res.ok) {
                const err = await res.json();
                return { success: false, message: err.message || "ลบไม่สำเร็จ" };
              }

              return { success: true };
            } catch (err) {
              return { success: false, message: err.message };
            }
          },

          async updateInternCheckbox(memberId, col, checked) {
            // ✅ เก็บสถานะเช้า/บ่ายไว้ใน localStorage (ไม่พึ่ง backend)
            const id = String(memberId || "");
            if (id) {
              if (col === "D") writeMeta(id, { morning: !!checked });
              if (col === "E") writeMeta(id, { noon: !!checked });
            }
            return { success: true };
          },

          async updateInternStatus(memberId, status) {
            // ✅ เก็บสถานะงานไว้ใน localStorage (ไม่พึ่ง backend)
            const id = String(memberId || "");
            if (id) writeMeta(id, { status: String(status || "") });
            return { success: true };
          }
        };
      })();

      /* Intern Module */
      (function initInternTabOnce() {

        const S = window.__internState = {
          internData: [],
          internFiltered: [],
          internStartingData: [],
          internEndingData: [],
          editingStarting: false,
          editingEnding: false,
          positions: [],
          internManageMode: false,
          selectedPosition: ""
        };

        // ✅ Local meta (เช้า/บ่าย/สถานะ) เก็บใน localStorage ต่อ memberId
        function metaKey(memberId) { return `pm_intern_meta:${memberId}`; }

        function readMeta(memberId) {
          try { return JSON.parse(localStorage.getItem(metaKey(memberId)) || "{}") || {}; }
          catch { return {}; }
        }

        function writeMeta(memberId, patch) {
          const cur = readMeta(memberId);
          const next = { ...cur, ...patch };
          try { localStorage.setItem(metaKey(memberId), JSON.stringify(next)); } catch { }
          return next;
        }


        function escapeHtml(str) {
          return String(str ?? "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
        }

        function escapeAttr(str) {
          return String(str ?? "").replaceAll("&", "&amp;").replaceAll('"', "&quot;").replaceAll("'", "&#039;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
        }

        window.reloadInternTab = function () {
          S.internData = [];
          S.internFiltered = [];
          S.internStartingData = [];
          S.internEndingData = [];
          window.loadInternTab(true);
        };

        window.clearInternFilters = function () {
          const searchInput = document.getElementById("internSearch");
          if (searchInput) searchInput.value = "";
          S.selectedPosition = "";
          const selectedText = document.getElementById("selectedPositionText");
          if (selectedText) selectedText.textContent = "ตำแหน่งทั้งหมด";
          const dropdownItems = document.getElementById("positionDropdownItems");
          if (dropdownItems) dropdownItems.classList.remove("open");
          window.filterInterns();
        };

        window.togglePositionDropdown = function () {
          const items = document.getElementById("positionDropdownItems");
          if (items) items.classList.toggle("open");
        };

        window.selectPosition = function (value, label) {
          S.selectedPosition = value || "";
          const t = document.getElementById("selectedPositionText");
          if (t) t.textContent = label || "ตำแหน่งทั้งหมด";
          const items = document.getElementById("positionDropdownItems");
          if (items) items.classList.remove("open");
          window.filterInterns();
        };

        window.updatePositionDropdown = function () {
          const items = document.getElementById("positionDropdownItems");
          if (!items) return;
          let html = '<div class="dd-item-intern" onclick="selectPosition(\'\', \'ตำแหน่งทั้งหมด\')">ตำแหน่งทั้งหมด</div>';
          (S.positions || []).forEach(function (pos) {
            const escaped = escapeAttr(pos);
            html += '<div class="dd-item-intern" onclick="selectPosition(\'' + escaped + '\', \'' + escaped + '\')">' + escapeHtml(pos) + '</div>';
          });
          items.innerHTML = html;
        };

        document.addEventListener("click", function (e) {
          const dd = document.getElementById("positionDropdownToggle");
          const items = document.getElementById("positionDropdownItems");
          if (!dd || !items) return;
          if (e.target && e.target.closest && e.target.closest("#positionDropdownToggle")) return;
          const container = dd.closest(".custom-dropdown-intern");
          if (container && !container.contains(e.target)) items.classList.remove("open");
        }, true);

        window.filterInterns = function () {
          const input = document.getElementById("internSearch");
          const kw = (input ? input.value : "").toLowerCase().trim();
          const selectedPos = S.selectedPosition || "";
          S.internFiltered = (S.internData || []).filter(function (i) {
            const matchName = !kw || String(i.displayName || "").toLowerCase().includes(kw) || String(i.position || "").toLowerCase().includes(kw);
            const matchPos = !selectedPos || String(i.position || "") === selectedPos;
            return matchName && matchPos;
          });
          renderInternTable();
        };

        window.loadInternTab = function () {
          fetchInternMain();
          fetchStarting();
          fetchEnding();
        };

        window.toggleStartingAdd = function () {
          const form = document.getElementById("startingAddForm");
          if (!form) return;
          form.classList.toggle("show");
        };

        window.toggleEndingAdd = function () {
          const form = document.getElementById("endingAddForm");
          if (!form) return;
          form.classList.toggle("show");
        };

        window.toggleEditStarting = function () {
          S.editingStarting = !S.editingStarting;
          const btn = document.getElementById("editStartingBtn");
          const col = document.getElementById("startingActionCol");
          if (btn) {
            btn.innerHTML = S.editingStarting ? '<img src="https://img.icons8.com/?size=100&id=0YcjyJq4ROPU&format=png&color=000000" alt="check" style="width:14px;height:14px;"> เสร็จ' : '<img src="https://img.icons8.com/?size=100&id=ulYKuVdTiawZ&format=png&color=000000" alt="edit" style="width:14px;height:14px;"> แก้ไข';
          }
          if (col) col.style.display = S.editingStarting ? "table-cell" : "none";
          renderInternStartingTable();
        };

        window.toggleEditEnding = function () {
          S.editingEnding = !S.editingEnding;
          const btn = document.getElementById("editEndingBtn");
          const col = document.getElementById("endingActionCol");
          if (btn) {
            btn.innerHTML = S.editingEnding ? '<img src="https://img.icons8.com/?size=100&id=0YcjyJq4ROPU&format=png&color=000000" alt="check" style="width:14px;height:14px;"> เสร็จ' : '<img src="https://img.icons8.com/?size=100&id=ulYKuVdTiawZ&format=png&color=000000" alt="edit" style="width:14px;height:14px;"> แก้ไข';
          }
          if (col) col.style.display = S.editingEnding ? "table-cell" : "none";
          renderInternEndingTable();
        };

        window.toggleInternManageMode = function () {
          S.internManageMode = !S.internManageMode;
          const btn = document.getElementById("internManageBtn");
          const actionsHeader = document.getElementById("internActionsHeader");
          const actionsHeaderCol = document.getElementById("internActionsHeaderCol");
          const actionsBodyCol = document.getElementById("internActionsBodyCol");
          const addForm = document.getElementById("addInternForm");
          if (btn) btn.classList.toggle("active", S.internManageMode);
          const displayValue = S.internManageMode ? "" : "none";
          if (actionsHeader) actionsHeader.style.display = displayValue;
          if (actionsHeaderCol) actionsHeaderCol.style.display = displayValue;
          if (actionsBodyCol) actionsBodyCol.style.display = displayValue;
          if (addForm) {
            if (S.internManageMode) { addForm.classList.add("show"); updateAddInternPositionDatalist(); }
            else { addForm.classList.remove("show"); }
          }
          renderInternTable();
        };

        window.addStartingIntern = function () {
          const fullName = (document.getElementById("startingFullName")?.value || "").trim();
          const nickName = (document.getElementById("startingNickName")?.value || "").trim();
          const position = (document.getElementById("startingPosition")?.value || "").trim();
          const dateRange = (document.getElementById("startingDate")?.value || "").trim();
          if (!fullName || !position || !dateRange) { alert("กรุณากรอกข้อมูลให้ครบ"); return; }
          S.internStartingData.push({ fullName: fullName, nickname: nickName, position: position, dateRange: dateRange, notifyStatus: "" });
          document.getElementById("startingFullName").value = "";
          document.getElementById("startingNickName").value = "";
          document.getElementById("startingPosition").value = "";
          document.getElementById("startingDate").value = "";
          renderInternStartingTable();
          saveStartingToStore();
        };

        window.deleteStartingIntern = function (idx) {
          if (!confirm("ลบข้อมูลนี้ใช่หรือไม่?")) return;
          S.internStartingData.splice(idx, 1);
          renderInternStartingTable();
          saveStartingToStore();
        };

        window.toggleStartingNotified = function (idx) {
          const row = S.internStartingData[idx];
          if (!row) return;
          row.notifyStatus = row.notifyStatus ? "" : "แจ้งแล้ว";
          renderInternStartingTable();
          saveStartingToStore();
        };

        window.addEndingIntern = function () {
          const fullName = (document.getElementById("endingFullName")?.value || "").trim();
          const nickName = (document.getElementById("endingNickName")?.value || "").trim();
          const position = (document.getElementById("endingPosition")?.value || "").trim();
          const dateRange = (document.getElementById("endingDate")?.value || "").trim();
          if (!fullName || !position || !dateRange) { alert("กรุณากรอกข้อมูลให้ครบ"); return; }
          S.internEndingData.push({ fullName: fullName, nickname: nickName, position: position, dateRange: dateRange, notifyStatus: "" });
          document.getElementById("endingFullName").value = "";
          document.getElementById("endingNickName").value = "";
          document.getElementById("endingPosition").value = "";
          document.getElementById("endingDate").value = "";
          renderInternEndingTable();
          saveEndingToStore();
        };

        window.deleteEndingIntern = function (idx) {
          if (!confirm("ลบข้อมูลนี้ใช่หรือไม่?")) return;
          S.internEndingData.splice(idx, 1);
          renderInternEndingTable();
          saveEndingToStore();
        };

        window.toggleEndingNotified = function (idx) {
          const row = S.internEndingData[idx];
          if (!row) return;
          row.notifyStatus = row.notifyStatus ? "" : "แจ้งแล้ว";
          renderInternEndingTable();
          saveEndingToStore();
        };

        function renderInternTable() {
          const tbody = document.getElementById("internTableBody");
          if (!tbody) return;
          const colSpan = S.internManageMode ? 8 : 7;
          if (!S.internFiltered || !S.internFiltered.length) { tbody.innerHTML = '<tr><td colspan="' + colSpan + '" style="text-align:center;color:#999;">ไม่มีข้อมูล</td></tr>'; return; }
          let html = "";
          S.internFiltered.forEach(function (i) { html += rowInternHtml(i); });
          tbody.innerHTML = html;
        }

        function rowInternHtml(i) {
          const rawName = String(i.displayName || "");
          const rawPos = String(i.position || "");
          const memberId = String(i._id || "");
          const meta = i._meta || {};

          const rawStatus = String(meta.status || i.status || "ทำงาน");
          const rawNote = String(i.note || "");
          const rawFileLink = String(meta.fileLink || i.fileLink || "");

          const name = escapeHtml(rawName);
          const position = escapeHtml(rawPos);
          const note = escapeHtml(rawNote);

          const morningChecked = meta.morning ? "checked" : "";
          const noonChecked = meta.noon ? "checked" : "";

          const morning = '<input type="checkbox" ' + morningChecked +
            ' onchange="onInternCheckChange(\'' + escapeAttr(memberId) + '\', \'D\', this.checked)">';
          const noon = '<input type="checkbox" ' + noonChecked +
            ' onchange="onInternCheckChange(\'' + escapeAttr(memberId) + '\', \'E\', this.checked)">';

          const status =
            '<div class="status-dd" data-id="' + escapeAttr(memberId) + '" data-value="' + escapeAttr(rawStatus) + '">' +
            '<div class="status-selected" onclick="toggleStatusDD(this)">' +
            '<span class="status-text">' + escapeHtml(rawStatus) + '</span><span>▾</span>' +
            '</div>' +
            '<div class="status-items">' +
            '<div class="status-item" onclick="selectStatusDD(this, \'ทำงาน\')">ทำงาน</div>' +
            '<div class="status-item" onclick="selectStatusDD(this, \'ลา\')">ลา</div>' +
            '<div class="status-item" onclick="selectStatusDD(this, \'ไม่มาทำงาน\')">ไม่มาทำงาน</div>' +
            '<div class="status-item" onclick="selectStatusDD(this, \'จบแล้ว\')">จบแล้ว</div>' +
            '</div>' +
            '</div>';

          let fileCell = '<span style="color:#999;">-</span>';
          if (rawFileLink.trim()) {
            const url = escapeAttr(rawFileLink.trim());
            fileCell = '<a href="' + url + '" target="_blank" rel="noopener">📄 อัปเดตงาน</a>';
          }

          let actionCell = "";
          if (S.internManageMode) {
            actionCell =
              '<td style="text-align: center;">' +
              '<button onclick="deleteIntern(\'' + escapeAttr(memberId) + '\', \'' + escapeAttr(rawName) + '\')" ' +
              'style="background: none; border: none; cursor: pointer; color: #ef4444;">' +
              '<img src="https://img.icons8.com/?size=100&id=Gx6408t2AnyJ&format=png&color=000000" alt="Delete" style="width: 20px; height: 20px;">' +
              '</button>' +
              '</td>';
          }

          return '<tr>' +
            '<td><b>' + name + '</b></td>' +
            '<td>' + position + '</td>' +
            '<td>' + morning + '</td>' +
            '<td>' + noon + '</td>' +
            '<td>' + status + '</td>' +
            '<td>' + note + '</td>' +
            '<td>' + fileCell + '</td>' +
            actionCell +
            '</tr>';
        }

        function renderInternStartingTable() {
          const tbody = document.getElementById("internStartingBody");
          if (!tbody) return;
          const colSpan = S.editingStarting ? 6 : 5;
          if (!S.internStartingData || !S.internStartingData.length) { tbody.innerHTML = '<tr><td colspan="' + colSpan + '" style="text-align:center;color:#999;">ไม่มีข้อมูล</td></tr>'; return; }
          let html = "";
          S.internStartingData.forEach(function (i, idx) {
            const nick = (i.nickName ?? i.nickname ?? "");
            const date = (i.date ?? i.dateRange ?? "");
            const notified = !!(i.notified || i.notifyStatus);
            html += '<tr><td>' + escapeHtml(i.fullName || "") + '</td><td>' + escapeHtml(nick) + '</td><td>' + escapeHtml(i.position || "") + '</td><td style="text-align:center;">' + (escapeHtml(date) || "-") + '</td><td style="text-align:center;"><input type="checkbox" ' + (notified ? "checked" : "") + ' onchange="toggleStartingNotified(' + idx + ')"></td>';
            if (S.editingStarting) { html += '<td style="text-align:center;"><button class="delete-btn" onclick="deleteStartingIntern(' + idx + ')"><img src="https://img.icons8.com/?size=100&id=Gx6408t2AnyJ&format=png&color=000000" alt="trash" style="width:14px;height:14px;"></button></td>'; }
            html += '</tr>';
          });
          tbody.innerHTML = html;
        }

        function renderInternEndingTable() {
          const tbody = document.getElementById("internEndingBody");
          if (!tbody) return;
          const colSpan = S.editingEnding ? 6 : 5;
          if (!S.internEndingData || !S.internEndingData.length) { tbody.innerHTML = '<tr><td colspan="' + colSpan + '" style="text-align:center;color:#999;">ไม่มีข้อมูล</td></tr>'; return; }
          let html = "";
          S.internEndingData.forEach(function (i, idx) {
            const nick = (i.nickName ?? i.nickname ?? "");
            const date = (i.date ?? i.dateRange ?? "");
            const notified = !!(i.notified || i.notifyStatus);
            html += '<tr><td>' + escapeHtml(i.fullName || "") + '</td><td>' + escapeHtml(nick) + '</td><td>' + escapeHtml(i.position || "") + '</td><td style="text-align:center;">' + (escapeHtml(date) || "-") + '</td><td style="text-align:center;"><input type="checkbox" ' + (notified ? "checked" : "") + ' onchange="toggleEndingNotified(' + idx + ')"></td>';
            if (S.editingEnding) { html += '<td style="text-align:center;"><button class="delete-btn" onclick="deleteEndingIntern(' + idx + ')"><img src="https://img.icons8.com/?size=100&id=Gx6408t2AnyJ&format=png&color=000000" alt="trash" style="width:14px;height:14px;"></button></td>'; }
            html += '</tr>';
          });
          tbody.innerHTML = html;
        }

        async function fetchInternMain() {
  try {
    console.log("[Intern] fetchInternMain started");
    const result = await window.BACKEND.getInternData(1, 100);
    
    const items = Array.isArray(result.items) ? result.items : [];
    
    // ✅ ผสาน meta (เช้า/บ่าย/สถานะ/fileLink) จาก localStorage
    items.forEach(function (it) {
      const id = String(it?._id || "");
      it._meta = id ? readMeta(id) : {};
      
      // ✅ ถ้า fileLink ไม่อยู่ใน meta ให้อ่านจากส่วนสำรอง
      if (!it._meta.fileLink && it.fileLink) {
        it._meta.fileLink = it.fileLink;
      }
    });

    S.internData = items;
    S.internFiltered = S.internData.slice();
    // ... โค้ดต่อไป
  } catch (err) {
    console.error("[Intern] fetchInternMain error:", err);
            console.error("[Intern] fetchInternMain error:", err);
            S.internData = [];
            S.internFiltered = [];
            S.positions = [];
            window.updatePositionDropdown();
            renderInternTable();
          }
        }

        async function fetchStarting() {
          try {
            S.internStartingData = await window.BACKEND.getInternStarting();
            renderInternStartingTable();
          } catch (e) {
            S.internStartingData = [];
            renderInternStartingTable();
          }
        }

        async function fetchEnding() {
          try {
            S.internEndingData = await window.BACKEND.getInternEnding();
            renderInternEndingTable();
          } catch (e) {
            S.internEndingData = [];
            renderInternEndingTable();
          }
        }

        async function saveStartingToStore() {
          const res = await window.BACKEND.saveInternStarting(S.internStartingData);
          if (!res?.success) console.warn("บันทึก starting ไม่สำเร็จ");
        }

        async function saveEndingToStore() {
          const res = await window.BACKEND.saveInternEnding(S.internEndingData);
          if (!res?.success) console.warn("บันทึก ending ไม่สำเร็จ");
        }

        function updateAddInternPositionDatalist() {
          const dl = document.getElementById("addInternPositionDatalist");
          if (!dl) return;
          dl.innerHTML = "";
          (S.positions || []).forEach(function (pos) {
            const opt = document.createElement("option");
            opt.value = pos;
            dl.appendChild(opt);
          });
        }

        window.addNewInternSubmit = async function () {
          const name = (document.getElementById("newInternName")?.value || "").trim();
          const position = (document.getElementById("newInternPosition")?.value || "").trim();
          const note = (document.getElementById("newInternNote")?.value || "").trim();
          const fileLink = (document.getElementById("newInternFileLink")?.value || "").trim();
          if (!name || !position) { alert("กรุณากรอกชื่อและตำแหน่ง"); return; }
          try {
            const res = await window.BACKEND.addNewIntern(name, position, note, fileLink);
            if (res?.success) {
              document.getElementById("newInternName").value = "";
              document.getElementById("newInternPosition").value = "";
              document.getElementById("newInternNote").value = "";
              document.getElementById("newInternFileLink").value = "";
              window.reloadInternTab();
            } else {
              alert(res?.message || "เพิ่มไม่สำเร็จ");
            }
          } catch (err) {
            alert("เกิดข้อผิดพลาด: " + (err?.message || err));
          }
        };

        window.hideAddInternForm = function () {
          S.internManageMode = false;
          const btn = document.getElementById("internManageBtn");
          const actionsHeader = document.getElementById("internActionsHeader");
          const actionsHeaderCol = document.getElementById("internActionsHeaderCol");
          const actionsBodyCol = document.getElementById("internActionsBodyCol");
          const addForm = document.getElementById("addInternForm");
          if (btn) btn.classList.remove("active");
          if (actionsHeader) actionsHeader.style.display = "none";
          if (actionsHeaderCol) actionsHeaderCol.style.display = "none";
          if (actionsBodyCol) actionsBodyCol.style.display = "none";
          if (addForm) addForm.classList.remove("show");
          renderInternTable();
        };

        window.onInternCheckChange = async function (memberId, col, checked) {
          try {
            const res = await window.BACKEND.updateInternCheckbox(memberId, col, !!checked);
            if (!res?.success) alert(res?.message || "บันทึกไม่สำเร็จ");
          } catch (err) {
            alert(err?.message || String(err));
          }
        };

        async function onInternStatusChange(memberId, status) {
          try {
            const res = await window.BACKEND.updateInternStatus(memberId, status);
            if (!res?.success) alert(res?.message || "บันทึกสถานะไม่สำเร็จ");
          } catch (err) {
            alert(err?.message || String(err));
          }
        }

        window.toggleStatusDD = function (el) {
          const items = el ? el.nextElementSibling : null;
          if (!items) return;
          document.querySelectorAll(".status-items.open").forEach(function (other) {
            if (other !== items) other.classList.remove("open");
          });
          const willOpen = !items.classList.contains("open");
          items.classList.toggle("open");
          if (willOpen) {
            const rect = el.getBoundingClientRect();
            items.style.top = (rect.bottom + 6) + "px";
            items.style.left = rect.left + "px";
          }
        };

        window.selectStatusDD = function (el, value) {
          const wrap = el ? el.closest(".status-dd") : null;
          if (!wrap) return;
          const memberId = wrap.dataset.id;
          wrap.dataset.value = value;
          const textEl = wrap.querySelector(".status-text");
          if (textEl) textEl.textContent = value;
          const items = wrap.querySelector(".status-items");
          if (items) items.classList.remove("open");
          onInternStatusChange(memberId, value);
        };

        document.addEventListener("click", function (e) {
          document.querySelectorAll(".status-items.open").forEach(function (items) {
            if (!items.parentElement.contains(e.target)) items.classList.remove("open");
          });
        }, true);

        window.deleteIntern = async function (memberId, name) {
          if (!confirm('ยืนยันลบ "' + name + '" ?')) return;
          try {
            const res = await window.BACKEND.deleteIntern(memberId);
            if (res?.success) window.reloadInternTab();
            else alert(res?.message || "ลบไม่สำเร็จ");
          } catch (err) {
            alert("เกิดข้อผิดพลาด: " + (err?.message || err));
          }
        };

        window.initIntern = function () {
          console.log("[Intern] initIntern called");
          if (typeof window.loadInternTab === "function") {
            window.loadInternTab();
          }
        };

        // อัพเดทโปรแกรมตรวจสอบการเตรียมการ init
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", function () {
            console.log("[Intern] DOMContentLoaded fired");
            window.initIntern();
          });
        } else {
          console.log("[Intern] Page already loaded, initializing...");
          setTimeout(window.initIntern, 100);
        }

        // Fallback: ตรวจสอบ custom tab:loaded event จาก Index.html
        window.addEventListener("tab:loaded", function (e) {
          console.log("[Intern] tab:loaded event received:", e.detail);
          if (e.detail?.tabName === "intern") {
            window.initIntern();
          }
        }, false);
      })();

      /* Scroll sync */
      (function () {
        function bindOneTableWrap(wrap) {
          const head = wrap.querySelector(".table-header-wrapper");
          const body = wrap.querySelector(".table-body-wrapper");
          if (!head || !body) return;
          if (body.__boundScrollSync) return;
          body.__boundScrollSync = true;
          const sync = () => { head.scrollLeft = body.scrollLeft; };
          body.addEventListener("scroll", () => {
            requestAnimationFrame(sync);
            document.querySelectorAll(".status-items.open").forEach(function (items) {
              items.classList.remove("open");
            });
          }, { passive: true });
          head.addEventListener("scroll", () => {
            if (body.scrollLeft !== head.scrollLeft) body.scrollLeft = head.scrollLeft;
          }, { passive: true });
          sync();
        }

        function bindAll() {
          document.querySelectorAll(".table-wrap").forEach(bindOneTableWrap);
        }

        document.addEventListener("DOMContentLoaded", bindAll);
        window.addEventListener("load", bindAll);
        window.addEventListener("resize", bindAll);
        const mo = new MutationObserver(() => bindAll());
        mo.observe(document.documentElement, { childList: true, subtree: true });
      })();
    </script>

</body>

</html>